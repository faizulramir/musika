<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Musika</title>
    <link href="/assets/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link rel="icon" type="image/x-icon" href="/assets/images/icon.png">
    <style>
        html,
        body {
            height: 100%;
            background: black;
            color: white;
        }

        form {
            width: 50%;
        }

        #answer-container .card {
            height: 100px;
        }

        @media only screen and (max-width: 768px) {
            form {
                width: 80%;
            }
        }
    </style>
</head>
<body>
    <div class="h-100 d-flex align-items-center justify-content-center">
        <form action="">
            <div class="pb-2">
                <div id="mainPage">
                    <div class="img-container" style="text-align: center;">
                        <img src="/assets/images/icon.png" width="50%">
                        <h4>Musika</h4>
                    </div>
                    <p style="text-align: center;" id="playerCountContainer">Player Count : <span id="playerCount">0</span></p>
                    <p style="text-align: center;" id="roomid"></p>
    
                    <div class="input-form p-4" id="roomIdcontainer">
                        <label>Room ID</label>
                        <input type="text" class="form-control" name="room_id" id="room_id">
                    </div>
                    
                    <div class="p-1" style="text-align: center;">
                        <button id="joinBtn" type="button" class="btn btn-success" onclick="joinRoom()">Join</button>
                        <button id="createBtn" type="button" class="btn btn-primary" onclick="createRoom()">Create</button>
                        <button id="leaveBtn" type="button" class="btn btn-danger" onclick="leaveRoom()">Leave</button>
                        <button id="startBtn" type="button" class="btn btn-danger" onclick="startGame()">Start</button>
                    </div>
                </div>

                <div id="loadingPage" style="text-align: center;">
                    <h4>Ready!</h4>
                    <progress value="0" max="3" id="progressBar"></progress>
                </div>

                <div id="playPage" style="text-align: center; width: 100%;">
                    <h4>Guess the song! (<span id="level">1</span>/10)</h4>
                    <div id="answer-container" style="width: 100%;"></div>
                    <div class="row">
                        <div class="col-6" style="text-align: left;">
                            <p id="score"></p>
                        </div>
                        <div class="col-6" style="text-align: right;">
                            <p id="time"></p>
                        </div>
                    </div>
                </div>

                <div class="endPage" style="text-align: center; width: 100%;">
                    <h4>Top Scorer</h4>

                </div>
    
                <div class="fixed-bottom p-2">
                    <div class="progress" id="songProgress">
                        <div class="progress-bar" role="progressbar" id="songProgressBar" style="width: 100%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                    <div class="row">
                        <div class="col-6" style="text-align: left;">
                            <span id="userID">1231231231231</span>
                        </div>
                        <div class="col-6" style="text-align: right;">
                            <span>All rights reserved.</span>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</body>
<script src="/assets/jquery/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
<script src="/assets/bootstrap/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
<script src="/socket.io/socket.io.js"></script>
<script>
    $('#leaveBtn').hide()
    $('#startBtn').hide()
    $('#playerCountContainer').hide()
    $('#loadingPage').hide()
    $('#roomid').hide()
    $('#playPage').hide()
    $('#songProgress').hide()
    $('#score').hide()
    $('#time').hide()
    $('#endPage').hide()

    const socket = io();
    let userID = null
    let roomID = null
    let score = 0
    let levelMultiplier = 0.5
    let level = 1

    socket.on('connect', () => {
        $('#userID').text(socket.id)
        userID = socket.id
        socket.emit('setSocketId', {
            'userID': socket.id
        });
    });

    socket.on('userActivity', (data) => {
        console.log(data)
        if (data.event === 'createRoom') {
            if (data.code !== 404 && data.player === userID) {
                hideDiv() 
                roomID = data.room
                $('#roomid').show()
                $('#roomid').text("Room ID: " + data.room)
                $('#room_id').val(data.room)
                $('#playerCountContainer').show()
                $('#playerCount').text(data.players.length)
            }
        }

        if (data.event === 'joinRoom') {
            if (data.code !== 404 && data.player === userID) {
                hideDiv()
                $('#roomid').show()
                $('#roomid').text("Room ID: " + data.room)
                roomID = data.room
                $('#room_id').val(data.room)
                $('#playerCountContainer').show()
            }
            $('#playerCount').text(data.players.length)
        }

        if (data.event === 'leaveRoom') {
            if (data.code !== 404 && data.player === userID && data.room === roomID) {
                showDiv()
                $('#roomid').hide()
                $('#roomid').text('')
                $('#room_id').val('')
                $('#playerCountContainer').hide()
            }
            $('#playerCount').text(data.players.length)
        }
    });


    socket.on('gameActivity', (data) => {
        if (roomID === data.room) {
            $('#mainPage').hide()

            if (data.event === 'startGame') {
                $('#loadingPage').show()
                loadItem(data)
                level = data.level
                $('#level').text(level)
            }

            if (data.event === 'nextLevel') {
                $('#loadingPage').show()
                $('#playPage').hide()
                loadItem(data)
                level = data.level
                $('#level').text(level)
            }
        }
    });

    function loadItem(data) {
        var timeleft = 3;
        var downloadTimer = setInterval(function(){
            if(timeleft <= 0){
                clearInterval(downloadTimer);
                $('#loadingPage').hide()
                startTimer(data)
            }
            document.getElementById("progressBar").value = 3 - timeleft;
            timeleft -= 1;
        }, 1000);
    }

    let songTimer = false
    function startTimer(data) {
        $('#playPage').show()
        $('#songProgress').show()
        $('#answer-container').empty();

        let answersDiv = '<div class="row p-2">'
        data.answers.forEach(function (value, i) {
            answersDiv +=   ` 
                                <div class="col-6 card p-2 answers d-flex align-items-center justify-content-center" onclick="pickAnswer(${i})" id="${i}">
                                    <span class="answer">${value}</span>
                                </div>
                            `
        });
        answersDiv += '</div>'
        
        $("#answer-container").append(answersDiv);   

        var timeleft = 1;
        var downloadTimer = setInterval(function(){
            // console.log(timeleft)
            if(timeleft >= 10){
                clearInterval(downloadTimer);
                songTimer = true
                levelEnded(data)
            }
            $('#songProgressBar').css('width', 10 * timeleft +'%');
            timeleft += 1;
        }, 1000);
        startSong(data)
    }

    let start = new Date();
    function startSong(data) {
        var audio = new Audio(data.songPath);
        audio.play();
        start = new Date()
    }

    let answer = {
        'time': new Date().getMilliseconds(),
        'answer': '',
        'id': '',
        'isCorrect': false
    }


    function pickAnswer(id) {
        
        if (!songTimer) {
            $('.answers').each(function(i, obj) {
                $('#' + obj.id).css('background', 'white')
                $('#' + obj.id).css('color', 'black')
            });

            $('#' + id).css('background', 'blue');
            $('#' + id).css('color', 'white');

            answer = {
                'time': new Date() - start,
                'answer': $('#' + id + ' span').text(),
                'id': id,
                'isCorrect': false
            }
        }
    }

    function levelEnded(data) {
        $('.answers').each(function(i, obj) {
            if (answer.id !== '') {
                if (answer.answer !== data.answer) {
                    $('#' + answer.id).css('background', 'red');
                    $('#' + answer.id).css('color', 'white');
                } else {
                    $('#' + answer.id).css('background', 'blue');
                    $('#' + answer.id).css('color', 'white');
                    answer.isCorrect = true
                }
            }
        });

        $('.answers').each(function(i, obj) {
            if ($('#' + obj.id + ' span').text() === data.answer) {
                $('#' + obj.id).css('background', 'green');
                $('#' + obj.id).css('color', 'white');
            }
        });

        if (answer.isCorrect)  {
            score = Math.round(score + (levelMultiplier * answer.time))
        }
       
        $('#score').show();
        $('#time').show();

        $('#time').text("Time: " + answer.time + 'ms');
        $('#score').text("Score: " + score);
       
        if (level < 3) {
            var timeleft = 3;
            var downloadTimer = setInterval(function(){
                if(timeleft <= 0){
                    clearInterval(downloadTimer);
                    $('#score').hide();
                    $('#time').hide();
                    songTimer = false
                    socket.emit('nextLevel', {
                        'userID': userID,
                        'roomID': $('#room_id').val(),
                        'level': level + 1
                    });
                }
                timeleft -= 1;
            }, 1000);
        }
    }

    function hideDiv() {
        $('#createBtn').hide()
        $('#joinBtn').hide()
        $('#leaveBtn').show()
        $('#roomIdcontainer').hide()
        $('#startBtn').show()
    }

    function showDiv() {
        $('#createBtn').show()
        $('#joinBtn').show()
        $('#leaveBtn').hide()
        $('#roomIdcontainer').show()
        $('#startBtn').hide()
    }

    function createRoom() {
        socket.emit('createRoom', userID);
    }

    function startGame() {
        console.log($('#room_id').val())
        socket.emit('startGame', {
            'userID': userID,
            'roomID': $('#room_id').val()
        });
    }

    function joinRoom() {
        socket.emit('joinRoom', {
            'userID': userID,
            'roomID': $('#room_id').val()
        });
    }

    function leaveRoom() {
        socket.emit('leaveRoom', {
            'userID': userID,
            'roomID': $('#room_id').val()
        });
        showDiv()
    }
</script>
</html>